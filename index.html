<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SleepGuard - Smart Sleep Quality Monitor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .status-online {
            background: linear-gradient(45deg, #00c851, #007e33);
            color: white;
        }

        .status-offline {
            background: linear-gradient(45deg, #ff4444, #cc0000);
            color: white;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .card-icon {
            font-size: 2rem;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .metric-unit {
            font-size: 1rem;
            color: #7f8c8d;
            font-weight: 500;
        }

        .sleep-score {
            text-align: center;
            position: relative;
        }

        .score-circle {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            position: relative;
        }

        .progress-ring {
            transform: rotate(-90deg);
        }

        .progress-ring-circle {
            stroke-dasharray: 283;
            stroke-dashoffset: 283;
            transition: stroke-dashoffset 0.8s ease-in-out;
            fill: transparent;
            stroke-width: 8;
            r: 45;
            cx: 60;
            cy: 60;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .sleep-phases {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .phase {
            text-align: center;
            flex: 1;
        }

        .phase-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .phase-label {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .recommendations {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .recommendation-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            backdrop-filter: blur(5px);
        }

        .recommendation-item:last-child {
            margin-bottom: 0;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-warning {
            background: linear-gradient(45deg, #ffc107, #ff8f00);
            color: white;
        }

        .alert-danger {
            background: linear-gradient(45deg, #dc3545, #a71d2a);
            color: white;
        }

        .alert-success {
            background: linear-gradient(45deg, #28a745, #1e7e34);
            color: white;
        }

        .settings-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 250px;
            z-index: 1000;
        }

        .settings-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .settings-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s ease;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .environmental-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .env-metric {
            text-align: center;
            padding: 15px;
            background: rgba(103, 126, 234, 0.1);
            border-radius: 10px;
        }

        .sleep-timeline {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
        }

        .timeline-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .timeline-item:last-child {
            border-bottom: none;
        }

        .timeline-time {
            font-weight: 600;
            color: #667eea;
            min-width: 80px;
        }

        .timeline-event {
            color: #6c757d;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .settings-panel {
                position: relative;
                top: 0;
                right: 0;
                margin-bottom: 20px;
            }
            
            .environmental-metrics {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🌙 Ardius Gacor</h1>
            <p>Advanced Sleep Quality Analysis & Real-time Monitoring</p>
            <div class="connection-status">
                <div class="status-indicator" id="connectionStatus">
                    <div class="status-dot"></div>
                    <span id="statusText">Connecting...</span>
                </div>
                <div id="lastUpdate">Last update: Never</div>
            </div>
        </div>

        <div class="settings-panel">
            <h3>🔧 Connection Settings</h3>
            <input type="text" id="deviceIP" class="settings-input" placeholder="ESP32 IP Address" value="192.168.0.104">
            <button class="btn" onclick="connectToDevice()">Connect Device</button>
            <div style="margin-top: 15px; font-size: 12px; color: #666;">
                <strong>Current IP:</strong> <span id="currentIP">Not connected</span>
            </div>
        </div>

        <div id="alertContainer"></div>

        <div class="dashboard-grid">
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">💤</span>
                    <span class="card-title">Sleep Quality Score</span>
                </div>
                <div class="sleep-score">
                    <div class="score-circle">
                        <svg class="progress-ring" width="120" height="120">
                            <circle class="progress-ring-circle" id="scoreCircle" stroke="#667eea" />
                        </svg>
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                            <div class="metric-value" id="sleepScore">--</div>
                            <div class="metric-unit">Score</div>
                        </div>
                    </div>
                    <div id="sleepQuality" style="font-weight: 600; color: #667eea;">Analyzing...</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-icon">❤️</span>
                    <span class="card-title">Heart Rate Monitor</span>
                </div>
                <div class="metric-value" id="heartRate">--</div>
                <div class="metric-unit">BPM</div>
                <div style="margin-top: 10px;">
                    <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                        <div>
                            <div style="font-size: 1.2rem; font-weight: 600;" id="avgHeartRate">--</div>
                            <div style="font-size: 0.9rem; color: #7f8c8d;">Average</div>
                        </div>
                        <div>
                            <div style="font-size: 1.2rem; font-weight: 600;" id="heartRateVariability">--</div>
                            <div style="font-size: 0.9rem; color: #7f8c8d;">HRV</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-icon">🩸</span>
                    <span class="card-title">Blood Oxygen</span>
                </div>
                <div class="metric-value" id="spO2">--</div>
                <div class="metric-unit">% SpO2</div>
                <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                    <div style="font-size: 0.9rem; color: #6c757d;">Normal Range: 95-100%</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-icon">🌡️</span>
                    <span class="card-title">Room Temperature</span>
                </div>
                <div class="metric-value" id="temperature">--</div>
                <div class="metric-unit">°C</div>
                <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                    <div style="font-size: 0.9rem; color: #6c757d;">Optimal: 18-22°C</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-icon">🔊</span>
                    <span class="card-title">Noise Level</span>
                </div>
                <div class="metric-value" id="soundLevel">--</div>
                <div class="metric-unit">%</div>
                <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                    <div style="font-size: 0.9rem; color: #6c757d;">Sleep Friendly: < 30%</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-icon">💡</span>
                    <span class="card-title">Light Level</span>
                </div>
                <div class="metric-value" id="lightLevel">--</div>
                <div class="metric-unit">lux</div>
                <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                    <div style="font-size: 0.9rem; color: #6c757d;">Sleep Mode: < 10 lux</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-icon">🚶</span>
                    <span class="card-title">Movement Detection</span>
                </div>
                <div class="metric-value" id="motionStatus">--</div>
                <div class="metric-unit">Status</div>
                <div style="margin-top: 15px;">
                    <div style="display: flex; justify-content: space-between;">
                        <div>
                            <div style="font-size: 1.2rem; font-weight: 600;" id="movementCount">0</div>
                            <div style="font-size: 0.9rem; color: #7f8c8d;">Tonight</div>
                        </div>
                        <div>
                            <div style="font-size: 1.2rem; font-weight: 600;" id="restlessness">Low</div>
                            <div style="font-size: 0.9rem; color: #7f8c8d;">Activity</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-icon">📊</span>
                    <span class="card-title">Sleep Statistics</span>
                </div>
                <div class="sleep-phases">
                    <div class="phase">
                        <div class="phase-value" id="deepSleep">--</div>
                        <div class="phase-label">Deep Sleep</div>
                    </div>
                    <div class="phase">
                        <div class="phase-value" id="lightSleep">--</div>
                        <div class="phase-label">Light Sleep</div>
                    </div>
                    <div class="phase">
                        <div class="phase-value" id="remSleep">--</div>
                        <div class="phase-label">REM Sleep</div>
                    </div>
                </div>
                <div class="sleep-timeline">
                    <div class="timeline-item">
                        <div class="timeline-time" id="sleepStart">--:--</div>
                        <div class="timeline-event">Sleep started</div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-time" id="deepPhase">--:--</div>
                        <div class="timeline-event">Deep sleep phase</div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-time" id="lightPhase">--:--</div>
                        <div class="timeline-event">Light sleep phase</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="charts-section">
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">📈</span>
                    <span class="card-title">Heart Rate Trend</span>
                </div>
                <div class="chart-container">
                    <canvas id="heartRateChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-icon">🌡️</span>
                    <span class="card-title">Environmental Conditions</span>
                </div>
                <div class="chart-container">
                    <canvas id="environmentChart"></canvas>
                </div>
            </div>
        </div>

        <div class="card recommendations">
            <div class="card-header" style="color: white;">
                <span class="card-icon" style="color: white;">💡</span>
                <span class="card-title" style="color: white;">Sleep Recommendations</span>
            </div>
            <div id="recommendationsList">
                <div class="recommendation-item">
                    <strong>🔄 Analyzing your sleep patterns...</strong><br>
                    Personalized recommendations will appear here based on your sensor data.
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let deviceIP = '192.168.0.104';
        let isConnected = false;
        let websocket = null;
        let sensorData = {
            temperature: 0,
            light: 0,
            sound: 0,
            motion: false,
            heartRate: 0,
            spO2: 0,
            timestamp: 0
        };

        // Sleep tracking variables
        let sleepSession = {
            startTime: null,
            heartRateHistory: [],
            movementCount: 0,
            environmentalConditions: [],
            sleepPhases: {
                deep: 0,
                light: 0,
                rem: 0
            }
        };

        // Charts
        let heartRateChart, environmentChart;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            connectToDevice();
            setInterval(updateSleepAnalysis, 5000); // Update every 5 seconds
        });

        // Device connection functions
        function connectToDevice() {
            const ipInput = document.getElementById('deviceIP');
            deviceIP = ipInput.value || '192.168.0.104';
            document.getElementById('currentIP').textContent = deviceIP;
            
            updateConnectionStatus('Connecting...', false);
            
            // Try WebSocket connection first
            connectWebSocket();
            
            // Fallback to HTTP polling
            setTimeout(() => {
                if (!isConnected) {
                    startHttpPolling();
                }
            }, 3000);
        }

        function connectWebSocket() {
            try {
                if (websocket) {
                    websocket.close();
                }
                
                websocket = new WebSocket(`ws://${deviceIP}:81`);
                
                websocket.onopen = function() {
                    updateConnectionStatus('Connected (WebSocket)', true);
                    isConnected = true;
                    clearAlerts();
                    showAlert('🎉 Successfully connected to ESP32 device!', 'success');
                };
                
                websocket.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        processSensorData(data);
                    } catch (e) {
                        console.error('WebSocket data parse error:', e);
                    }
                };
                
                websocket.onerror = function() {
                    updateConnectionStatus('WebSocket Error', false);
                    isConnected = false;
                };
                
                websocket.onclose = function() {
                    updateConnectionStatus('Disconnected', false);
                    isConnected = false;
                    setTimeout(connectWebSocket, 5000); // Retry after 5 seconds
                };
                
            } catch (error) {
                console.error('WebSocket connection failed:', error);
                updateConnectionStatus('Connection Failed', false);
            }
        }

        function startHttpPolling() {
            const pollData = async () => {
                try {
                    const response = await fetch(`http://${deviceIP}/data`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        processSensorData(data);
                        
                        if (!isConnected) {
                            updateConnectionStatus('Connected (HTTP)', true);
                            isConnected = true;
                            clearAlerts();
                            showAlert('📡 Connected via HTTP polling', 'success');
                        }
                    } else {
                        throw new Error('HTTP request failed');
                    }
                } catch (error) {
                    if (isConnected) {
                        updateConnectionStatus('Connection Lost', false);
                        isConnected = false;
                        showAlert('⚠️ Lost connection to ESP32 device', 'warning');
                    }
                }
            };
            
            // Poll every 2 seconds
            setInterval(pollData, 2000);
            pollData(); // Initial call
        }

        function processSensorData(data) {
            // Update sensor data
            sensorData = {
                temperature: parseFloat(data.temperature) || 0,
                light: parseInt(data.light) || 0,
                sound: parseInt(data.sound) || 0,
                motion: Boolean(data.motion),
                heartRate: parseInt(data.heartRate) || 0,
                spO2: parseInt(data.spO2) || 0,
                timestamp: data.timestamp || Date.now()
            };
            
            updateDashboard();
            updateSleepTracking();
            updateCharts();
            
            // Update last update time
            document.getElementById('lastUpdate').textContent = `Last update: ${new Date().toLocaleTimeString()}`;
        }

        function updateDashboard() {
            // Update heart rate
            document.getElementById('heartRate').textContent = sensorData.heartRate || '--';
            
            // Update SpO2
            document.getElementById('spO2').textContent = sensorData.spO2 || '--';
            
            // Update temperature
            document.getElementById('temperature').textContent = sensorData.temperature.toFixed(1);
            
            // Update sound level
            document.getElementById('soundLevel').textContent = sensorData.sound;
            
            // Update light level
            document.getElementById('lightLevel').textContent = sensorData.light;
            
            // Update motion status
            document.getElementById('motionStatus').textContent = sensorData.motion ? '🟡 Active' : '🟢 Still';
            
            // Update movement count
            if (sensorData.motion) {
                sleepSession.movementCount++;
                document.getElementById('movementCount').textContent = sleepSession.movementCount;
            }
            
            // Update restlessness indicator
            const restlessness = sleepSession.movementCount > 20 ? 'High' : 
                               sleepSession.movementCount > 10 ? 'Medium' : 'Low';
            document.getElementById('restlessness').textContent = restlessness;
        }

        function updateSleepTracking() {
            // Initialize sleep session if not started
            if (!sleepSession.startTime && sensorData.heartRate > 0) {
                sleepSession.startTime = new Date();
                document.getElementById('sleepStart').textContent = sleepSession.startTime.toLocaleTimeString();
                showAlert('😴 Sleep tracking started!', 'success');
            }
            
            // Store heart rate history
            if (sensorData.heartRate > 0) {
                sleepSession.heartRateHistory.push({
                    time: new Date(),
                    rate: sensorData.heartRate,
                    spO2: sensorData.spO2
                });
                
                // Keep only last 100 readings
                if (sleepSession.heartRateHistory.length > 100) {
                    sleepSession.heartRateHistory.shift();
                }
                
                // Calculate average heart rate
                const avgHR = sleepSession.heartRateHistory.reduce((sum, reading) => sum + reading.rate, 0) / sleepSession.heartRateHistory.length;
                document.getElementById('avgHeartRate').textContent = Math.round(avgHR);
                
                // Calculate HRV (simplified)
                if (sleepSession.heartRateHistory.length > 1) {
                    const hrv = calculateHRV(sleepSession.heartRateHistory);
                    document.getElementById('heartRateVariability').textContent = hrv + 'ms';
                }
            }
            
            // Store environmental conditions
            sleepSession.environmentalConditions.push({
                time: new Date(),
                temperature: sensorData.temperature,
                light: sensorData.light,
                sound: sensorData.sound
            });
            
            // Keep only last 50 readings
            if (sleepSession.environmentalConditions.length > 50) {
                sleepSession.environmentalConditions.shift();
            }
        }

        function updateSleepAnalysis() {
            if (!sleepSession.startTime) return;
            
            const sleepDuration = (new Date() - sleepSession.startTime) / (1000 * 60 * 60); // hours
            
            // Analyze sleep phases based on heart rate patterns
            analyzeSleepPhases();
            
            // Calculate sleep quality score
            const sleepScore = calculateSleepQualityScore();
            updateSleepScore(sleepScore);
            
            // Generate recommendations
            generateRecommendations();
            
            // Check for alerts
            checkSleepAlerts();
        }

        function analyzeSleepPhases() {
            if (sleepSession.heartRateHistory.length < 10) return;
            
            const recent = sleepSession.heartRateHistory.slice(-10);
            const avgRecent = recent.reduce((sum, r) => sum + r.rate, 0) / recent.length;
            const overallAvg = sleepSession.heartRateHistory.reduce((sum, r) => sum + r.rate, 0) / sleepSession.heartRateHistory.length;
            
            // Simplified sleep phase detection
            if (avgRecent < overallAvg - 10) {
                sleepSession.sleepPhases.deep += 0.1;
                document.getElementById('deepPhase').textContent = new Date().toLocaleTimeString();
            } else if (avgRecent > overallAvg + 5) {
                sleepSession.sleepPhases.rem += 0.1;
            } else {
                sleepSession.sleepPhases.light += 0.1;
            }
            
            // Update display
            document.getElementById('deepSleep').textContent = Math.round(sleepSession.sleepPhases.deep) + 'h';
            document.getElementById('lightSleep').textContent = Math.round(sleepSession.sleepPhases.light) + 'h';
            document.getElementById('remSleep').textContent = Math.round(sleepSession.sleepPhases.rem) + 'h';
            document.getElementById('lightPhase').textContent = new Date().toLocaleTimeString();
        }

        function calculateSleepQualityScore() {
            let score = 100;
            
            // Temperature factor (optimal 18-22°C)
            if (sensorData.temperature < 18 || sensorData.temperature > 22) {
                score -= Math.abs(sensorData.temperature - 20) * 3;
            }
            
            // Light factor (should be dark)
            if (sensorData.light > 10) {
                score -= Math.min(sensorData.light / 2, 20);
            }
            
            // Sound factor (should be quiet)
            if (sensorData.sound > 30) {
                score -= Math.min(sensorData.sound - 30, 25);
            }
            
            // Movement factor (less is better)
            if (sleepSession.movementCount > 0) {
                score -= Math.min(sleepSession.movementCount * 2, 30);
            }
            
            // Heart rate stability
            if (sleepSession.heartRateHistory.length > 5) {
                const hrVariation = calculateHeartRateVariation();
                if (hrVariation > 20) {
                    score -= Math.min((hrVariation - 20) * 1.5, 20);
                }
            }
            
            // SpO2 factor
            if (sensorData.spO2 > 0 && sensorData.spO2 < 95) {
                score -= (95 - sensorData.spO2) * 5;
            }
            
            return Math.max(Math.round(score), 0);
        }

        function calculateHeartRateVariation() {
            if (sleepSession.heartRateHistory.length < 2) return 0;
            
            const rates = sleepSession.heartRateHistory.map(h => h.rate);
            const avg = rates.reduce((sum, rate) => sum + rate, 0) / rates.length;
            const variance = rates.reduce((sum, rate) => sum + Math.pow(rate - avg, 2), 0) / rates.length;
            return Math.sqrt(variance);
        }

        function calculateHRV(history) {
            if (history.length < 2) return 0;
            
            const intervals = [];
            for (let i = 1; i < history.length; i++) {
                const timeDiff = history[i].time - history[i-1].time;
                if (timeDiff > 0) {
                    intervals.push(60000 / history[i].rate - 60000 / history[i-1].rate);
                }
            }
            
            if (intervals.length === 0) return 0;
            
            const mean = intervals.reduce((sum, interval) => sum + interval, 0) / intervals.length;
            const variance = intervals.reduce((sum, interval) => sum + Math.pow(interval - mean, 2), 0) / intervals.length;
            return Math.round(Math.sqrt(variance) * 1000);
        }

        function updateSleepScore(score) {
            document.getElementById('sleepScore').textContent = score;
            
            const circle = document.getElementById('scoreCircle');
            const circumference = 2 * Math.PI * 45;
            const strokeDashoffset = circumference - (score / 100 * circumference);
            circle.style.strokeDashoffset = strokeDashoffset;
            
            // Update quality text and color
            let quality, color;
            if (score >= 85) {
                quality = 'Excellent Sleep';
                color = '#28a745';
            } else if (score >= 70) {
                quality = 'Good Sleep';
                color = '#17a2b8';
            } else if (score >= 55) {
                quality = 'Fair Sleep';
                color = '#ffc107';
            } else {
                quality = 'Poor Sleep';
                color = '#dc3545';
            }
            
            document.getElementById('sleepQuality').textContent = quality;
            document.getElementById('sleepQuality').style.color = color;
            circle.setAttribute('stroke', color);
        }

        function generateRecommendations() {
            const recommendations = [];
            
            // Temperature recommendations
            if (sensorData.temperature < 18) {
                recommendations.push({
                    icon: '🌡️',
                    title: 'Room Too Cold',
                    text: `Current temperature is ${sensorData.temperature.toFixed(1)}°C. Consider warming the room to 18-22°C for optimal sleep.`
                });
            } else if (sensorData.temperature > 22) {
                recommendations.push({
                    icon: '❄️',
                    title: 'Room Too Warm',
                    text: `Current temperature is ${sensorData.temperature.toFixed(1)}°C. Consider cooling the room to 18-22°C for better sleep quality.`
                });
            }
            
            // Light recommendations
            if (sensorData.light > 10) {
                recommendations.push({
                    icon: '🌙',
                    title: 'Reduce Light Exposure',
                    text: `Light level is ${sensorData.light} lux. Use blackout curtains or eye mask to create darker environment.`
                });
            }
            
            // Sound recommendations
            if (sensorData.sound > 30) {
                recommendations.push({
                    icon: '🔇',
                    title: 'Noise Disturbance',
                    text: `Sound level is ${sensorData.sound}%. Consider using earplugs or white noise machine.`
                });
            }
            
            // Movement recommendations
            if (sleepSession.movementCount > 15) {
                recommendations.push({
                    icon: '🛏️',
                    title: 'Restless Sleep Detected',
                    text: `${sleepSession.movementCount} movements detected. Check mattress comfort and room temperature.`
                });
            }
            
            // Heart rate recommendations
            if (sensorData.heartRate > 80) {
                recommendations.push({
                    icon: '❤️',
                    title: 'Elevated Heart Rate',
                    text: `Heart rate is ${sensorData.heartRate} BPM. Practice relaxation techniques before bed.`
                });
            }
            
            // SpO2 recommendations
            if (sensorData.spO2 > 0 && sensorData.spO2 < 95) {
                recommendations.push({
                    icon: '🫁',
                    title: 'Low Blood Oxygen',
                    text: `SpO2 is ${sensorData.spO2}%. Ensure good ventilation and consult healthcare provider if persistent.`
                });
            }
            
            // Default recommendations if all is well
            if (recommendations.length === 0) {
                recommendations.push({
                    icon: '✅',
                    title: 'Optimal Sleep Conditions',
                    text: 'All environmental factors are within optimal ranges. Keep up the good sleep hygiene!'
                });
            }
            
            updateRecommendationsDisplay(recommendations);
        }

        function updateRecommendationsDisplay(recommendations) {
            const container = document.getElementById('recommendationsList');
            container.innerHTML = '';
            
            recommendations.forEach(rec => {
                const item = document.createElement('div');
                item.className = 'recommendation-item';
                item.innerHTML = `
                    <strong>${rec.icon} ${rec.title}</strong><br>
                    ${rec.text}
                `;
                container.appendChild(item);
            });
        }

        function checkSleepAlerts() {
            clearAlerts();
            
            // Critical SpO2 alert
            if (sensorData.spO2 > 0 && sensorData.spO2 < 90) {
                showAlert('🚨 Critical: Blood oxygen level very low! Consider seeking medical attention.', 'danger');
            }
            
            // High heart rate alert
            if (sensorData.heartRate > 100) {
                showAlert('⚠️ Warning: Heart rate is elevated during sleep.', 'warning');
            }
            
            // Poor sleep environment
            if (sensorData.light > 50 || sensorData.sound > 60) {
                showAlert('💡 Tip: Your sleep environment could be improved for better rest.', 'warning');
            }
        }

        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = message;
            container.appendChild(alert);
            
            // Auto remove after 10 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 10000);
        }

        function clearAlerts() {
            document.getElementById('alertContainer').innerHTML = '';
        }

        function updateConnectionStatus(status, connected) {
            const statusElement = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            
            statusText.textContent = status;
            statusElement.className = `status-indicator ${connected ? 'status-online' : 'status-offline'}`;
        }

        function initializeCharts() {
            // Heart Rate Chart
            const heartRateCtx = document.getElementById('heartRateChart').getContext('2d');
            heartRateChart = new Chart(heartRateCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Heart Rate (BPM)',
                        data: [],
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'SpO2 (%)',
                        data: [],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 40,
                            max: 120,
                            title: {
                                display: true,
                                text: 'Heart Rate (BPM)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            min: 90,
                            max: 100,
                            title: {
                                display: true,
                                text: 'SpO2 (%)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    },
                    interaction: {
                        intersect: false,
                    }
                }
            });

            // Environment Chart
            const environmentCtx = document.getElementById('environmentChart').getContext('2d');
            environmentChart = new Chart(environmentCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Temperature (°C)',
                        data: [],
                        borderColor: '#f39c12',
                        backgroundColor: 'rgba(243, 156, 18, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Light (lux)',
                        data: [],
                        borderColor: '#f1c40f',
                        backgroundColor: 'rgba(241, 196, 15, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }, {
                        label: 'Sound (%)',
                        data: [],
                        borderColor: '#9b59b6',
                        backgroundColor: 'rgba(155, 89, 182, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y2'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'Temperature (°C)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Light (lux)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        },
                        y2: {
                            type: 'linear',
                            display: false,
                            min: 0,
                            max: 100
                        }
                    }
                }
            });
        }

        function updateCharts() {
            const now = new Date().toLocaleTimeString();
            
            // Update Heart Rate Chart
            if (heartRateChart && sensorData.heartRate > 0) {
                heartRateChart.data.labels.push(now);
                heartRateChart.data.datasets[0].data.push(sensorData.heartRate);
                heartRateChart.data.datasets[1].data.push(sensorData.spO2);
                
                // Keep only last 20 data points
                if (heartRateChart.data.labels.length > 20) {
                    heartRateChart.data.labels.shift();
                    heartRateChart.data.datasets[0].data.shift();
                    heartRateChart.data.datasets[1].data.shift();
                }
                
                heartRateChart.update('none');
            }
            
            // Update Environment Chart
            if (environmentChart) {
                environmentChart.data.labels.push(now);
                environmentChart.data.datasets[0].data.push(sensorData.temperature);
                environmentChart.data.datasets[1].data.push(sensorData.light);
                environmentChart.data.datasets[2].data.push(sensorData.sound);
                
                // Keep only last 20 data points
                if (environmentChart.data.labels.length > 20) {
                    environmentChart.data.labels.shift();
                    environmentChart.data.datasets[0].data.shift();
                    environmentChart.data.datasets[1].data.shift();
                    environmentChart.data.datasets[2].data.shift();
                }
                
                environmentChart.update('none');
            }
        }

        // Utility functions
        function formatTime(date) {
            return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        function exportSleepData() {
            const data = {
                session: sleepSession,
                currentData: sensorData,
                timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sleep-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                connectToDevice();
            }
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                exportSleepData();
            }
        });

        // Add service worker for offline functionality
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(function(error) {
                console.log('ServiceWorker registration failed: ', error);
            });
        }

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                console.log('Dashboard hidden - reducing update frequency');
            } else {
                console.log('Dashboard visible - resuming normal updates');
                if (!isConnected) {
                    connectToDevice();
                }
            }
        });

        // Auto-detect device IP on local network (optional enhancement)
        async function scanForDevice() {
            const localIP = await getLocalIP();
            if (localIP) {
                const baseIP = localIP.substring(0, localIP.lastIndexOf('.') + 1);
                // This would require additional implementation for IP scanning
                console.log('Local network base:', baseIP);
            }
        }

        function getLocalIP() {
            return new Promise((resolve) => {
                const pc = new RTCPeerConnection({iceServers: []});
                pc.createDataChannel('');
                pc.createOffer().then(pc.setLocalDescription.bind(pc));
                pc.onicecandidate = (ice) => {
                    if (ice && ice.candidate && ice.candidate.candidate) {
                        const ip = /([0-9]{1,3}(\.[0-9]{1,3}){3})/.exec(ice.candidate.candidate)[1];
                        resolve(ip);
                        pc.close();
                    }
                };
            });
        }
    </script>
</body>
</html>
