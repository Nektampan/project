<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sleep Quality Monitor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 50%, #2d1b69 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(138, 43, 226, 0.3) 0%, transparent 70%);
            border-radius: 50%;
            z-index: -1;
            animation: pulse 4s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.3; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.1; }
        }

        h1 {
            font-size: 3rem;
            background: linear-gradient(45deg, #8a2be2, #da70d6, #ff69b4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            text-shadow: 0 0 30px rgba(138, 43, 226, 0.5);
        }

        .subtitle {
            font-size: 1.2rem;
            color: #b19cd9;
            margin-bottom: 20px;
        }

        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ff4444;
            animation: blink 2s infinite;
        }

        .status-dot.connected {
            background: #00ff88;
            animation: none;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, #8a2be2, transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(138, 43, 226, 0.3);
        }

        .sensor-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #da70d6;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sensor-icon {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        .sensor-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ffffff, #b19cd9);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .sensor-unit {
            font-size: 1rem;
            color: #8a8a8a;
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .chart-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            height: 400px;
        }

        .chart-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: #da70d6;
            text-align: center;
        }

        .sleep-quality-card {
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.2), rgba(218, 112, 214, 0.1));
            border: 2px solid rgba(138, 43, 226, 0.3);
            text-align: center;
            grid-column: 1 / -1;
            margin-bottom: 20px;
        }

        .quality-score {
            font-size: 4rem;
            font-weight: bold;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #00ff88, #00ccff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .quality-label {
            font-size: 1.5rem;
            color: #b19cd9;
            margin-bottom: 15px;
        }

        .quality-description {
            font-size: 1.1rem;
            color: #8a8a8a;
            line-height: 1.5;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            background: linear-gradient(45deg, #8a2be2, #da70d6);
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(138, 43, 226, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(138, 43, 226, 0.5);
        }

        .btn:active {
            transform: translateY(0);
        }

        .footer {
            text-align: center;
            color: #8a8a8a;
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .chart-card {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Sleep Quality Monitor</h1>
            <p class="subtitle">Real-time IoT Sleep Analysis Dashboard</p>
            <div class="connection-status">
                <div class="status-dot" id="statusDot"></div>
                <span id="connectionStatus">Connecting to ESP32...</span>
            </div>
        </div>

        <div class="dashboard">
            <div class="card sleep-quality-card">
                <div class="quality-score" id="sleepScore">--</div>
                <div class="quality-label" id="sleepLabel">Calculating...</div>
                <div class="quality-description" id="sleepDescription">
                    Analyzing your sleep patterns based on environmental sensors
                </div>
            </div>

            <div class="card">
                <div class="sensor-title">
                    <svg class="sensor-icon" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                    Temperature
                </div>
                <div class="sensor-value" id="temperature">--</div>
                <div class="sensor-unit">째C</div>
            </div>

            <div class="card">
                <div class="sensor-title">
                    <svg class="sensor-icon" viewBox="0 0 24 24">
                        <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4c0-.73-.21-1.41-.55-2H17v-2h-3.55c-.34-.59-.55-1.27-.55-2V3H12z"/>
                    </svg>
                    Light Level
                </div>
                <div class="sensor-value" id="lightLevel">--</div>
                <div class="sensor-unit">lux</div>
            </div>

            <div class="card">
                <div class="sensor-title">
                    <svg class="sensor-icon" viewBox="0 0 24 24">
                        <path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/>
                    </svg>
                    Sound Level
                </div>
                <div class="sensor-value" id="soundLevel">--</div>
                <div class="sensor-unit">dB</div>
            </div>

            <div class="card">
                <div class="sensor-title">
                    <svg class="sensor-icon" viewBox="0 0 24 24">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                    Motion Detection
                </div>
                <div class="sensor-value" id="motionStatus">--</div>
                <div class="sensor-unit">status</div>
            </div>
        </div>

        <div class="charts-container">
            <div class="chart-card">
                <div class="chart-title">Temperature Trend</div>
                <canvas id="temperatureChart"></canvas>
            </div>
            
            <div class="chart-card">
                <div class="chart-title">Light & Sound Levels</div>
                <canvas id="lightSoundChart"></canvas>
            </div>
            
            <div class="chart-card">
                <div class="chart-title">Sleep Quality Over Time</div>
                <canvas id="sleepQualityChart"></canvas>
            </div>
            
            <div class="chart-card">
                <div class="chart-title">Motion Activity</div>
                <canvas id="motionChart"></canvas>
            </div>
        </div>

        <div class="controls">
            <button class="btn" onclick="resetData()">Reset Data</button>
            <button class="btn" onclick="exportData()">Export Data</button>
            <button class="btn" onclick="toggleConnection()">Reconnect</button>
        </div>

        <div class="footer">
            <p>&copy; 2025 Sleep Quality Monitor | Connected to ESP32 at 192.168.109.92 </p>
        </div>
    </div>

    <script>
        // Global variables
        let ws = null;
        let reconnectInterval = null;
        let sensorData = {
            temperature: [],
            lightLevel: [],
            soundLevel: [],
            motionDetected: [],
            sleepQuality: [],
            timestamps: []
        };

        // Chart instances
        let temperatureChart = null;
        let lightSoundChart = null;
        let sleepQualityChart = null;
        let motionChart = null;

        // ESP32 connection settings
        const ESP32_IP = '192.168.135.92';
        const WS_PORT = 81; // Default WebSocket port

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            connectToESP32();
            
            // Update connection status initially
            updateConnectionStatus(false);
        });

        // WebSocket connection to ESP32
        function connectToESP32() {
            try {
                // Try WebSocket connection first
                ws = new WebSocket(`ws://${ESP32_IP}:${WS_PORT}/`);
                
                ws.onopen = function(event) {
                    console.log('WebSocket connected to ESP32');
                    updateConnectionStatus(true);
                    clearInterval(reconnectInterval);
                };

                ws.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        updateSensorData(data);
                    } catch (e) {
                        console.error('Error parsing WebSocket data:', e);
                    }
                };

                ws.onclose = function(event) {
                    console.log('WebSocket connection closed');
                    updateConnectionStatus(false);
                    // Try to reconnect every 5 seconds
                    if (!reconnectInterval) {
                        reconnectInterval = setInterval(connectToESP32, 5000);
                    }
                };

                ws.onerror = function(error) {
                    console.error('WebSocket error:', error);
                    updateConnectionStatus(false);
                    // Fallback to HTTP polling
                    setTimeout(startHttpPolling, 2000);
                };

            } catch (error) {
                console.error('Failed to create WebSocket connection:', error);
                updateConnectionStatus(false);
                startHttpPolling();
            }
        }

        // Fallback HTTP polling method
        function startHttpPolling() {
            console.log('Starting HTTP polling fallback...');
            
            function pollData() {
                // Try multiple endpoints that ESP32 might use
                const endpoints = [
                    `http://${ESP32_IP}/api/sensors`,
                    `http://${ESP32_IP}/sensors`,
                    `http://${ESP32_IP}/data`,
                    `http://${ESP32_IP}/`
                ];
                
                let pollIndex = 0;
                
                function tryNextEndpoint() {
                    if (pollIndex >= endpoints.length) {
                        console.log('All endpoints failed, using mock data');
                        generateMockData();
                        return;
                    }
                    
                    fetch(endpoints[pollIndex])
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP ${response.status}`);
                            }
                            return response.text();
                        })
                        .then(text => {
                            console.log('Raw ESP32 response:', text);
                            try {
                                const data = JSON.parse(text);
                                updateSensorData(data);
                                updateConnectionStatus(true);
                            } catch (e) {
                                // Handle plain text responses
                                console.log('Parsing plain text response');
                                parsePlainTextResponse(text);
                                updateConnectionStatus(true);
                            }
                        })
                        .catch(error => {
                            console.error(`Endpoint ${endpoints[pollIndex]} failed:`, error);
                            pollIndex++;
                            tryNextEndpoint();
                        });
                }
                
                tryNextEndpoint();
            }

            // Poll every 2 seconds
            setInterval(pollData, 2000);
            pollData(); // Initial call
        }
        
        // Parse plain text response from ESP32
        function parsePlainTextResponse(text) {
            const data = {};
            const lines = text.split('\n');
            
            lines.forEach(line => {
                if (line.includes('Temperature:')) {
                    data.temperature = parseFloat(line.match(/[\d.]+/)[0]);
                } else if (line.includes('Light:') || line.includes('LDR:')) {
                    data.lightLevel = parseFloat(line.match(/[\d.]+/)[0]);
                } else if (line.includes('Sound:') || line.includes('Noise:')) {
                    data.soundLevel = parseFloat(line.match(/[\d.]+/)[0]);
                } else if (line.includes('Motion:') || line.includes('PIR:')) {
                    data.motionDetected = line.toLowerCase().includes('detected') || line.includes('1');
                }
            });
            
            console.log('Parsed plain text data:', data);
            updateSensorData(data);
        }

        // Generate mock data for demonstration
        function generateMockData() {
            const mockData = {
                temperature: 22 + Math.random() * 4, // 22-26째C
                light: Math.random() * 100, // Alternative key for light
                lightLevel: Math.random() * 100,
                ldr: Math.random() * 100, // ESP32 might send as 'ldr'
                sound: 30 + Math.random() * 20, // Alternative key for sound
                soundLevel: 30 + Math.random() * 20, // 30-50 dB
                motion: Math.random() > 0.8, // Alternative key for motion
                motionDetected: Math.random() > 0.8, // 20% chance of motion
                pir: Math.random() > 0.8, // ESP32 might send as 'pir'
                timestamp: Date.now()
            };
            
            updateSensorData(mockData);
        }

        // Update sensor data and UI
        function updateSensorData(data) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString();

            // Handle different possible key names from ESP32
            const temperature = data.temperature || data.temp || 0;
            const lightLevel = data.lightLevel || data.light || data.ldr || data.LDR || 0;
            const soundLevel = data.soundLevel || data.sound || data.noise || data.KY037 || 0;
            const motionDetected = data.motionDetected || data.motion || data.pir || data.PIR || false;

            // Update sensor values with better error handling
            document.getElementById('temperature').textContent = 
                temperature ? temperature.toFixed(1) : '--';
            document.getElementById('lightLevel').textContent = 
                lightLevel ? Math.round(lightLevel) : '--';
            document.getElementById('soundLevel').textContent = 
                soundLevel ? Math.round(soundLevel) : '--';
            document.getElementById('motionStatus').textContent = 
                motionDetected ? 'Detected' : 'Clear';

            // Debug logging
            console.log('Sensor Data Received:', {
                raw: data,
                processed: { temperature, lightLevel, soundLevel, motionDetected }
            });

            // Store data for charts
            sensorData.timestamps.push(timeStr);
            sensorData.temperature.push(temperature);
            sensorData.lightLevel.push(lightLevel);
            sensorData.soundLevel.push(soundLevel);
            sensorData.motionDetected.push(motionDetected ? 1 : 0);

            // Calculate sleep quality
            const sleepQuality = calculateSleepQuality({
                temperature,
                lightLevel,
                soundLevel,
                motionDetected
            });
            sensorData.sleepQuality.push(sleepQuality);
            updateSleepQualityDisplay(sleepQuality);

            // Keep only last 20 data points
            if (sensorData.timestamps.length > 20) {
                Object.keys(sensorData).forEach(key => {
                    sensorData[key].shift();
                });
            }

            // Update charts
            updateCharts();
        }

        // Calculate sleep quality based on sensor data
        function calculateSleepQuality(data) {
            let score = 100;
            
            // Temperature factor (optimal: 20-24째C)
            const temp = data.temperature || 22;
            if (temp < 18 || temp > 26) score -= 20;
            else if (temp < 20 || temp > 24) score -= 10;
            
            // Light factor (should be low for good sleep)
            const light = data.lightLevel || 0;
            if (light > 50) score -= 25;
            else if (light > 20) score -= 10;
            
            // Sound factor (should be low for good sleep)
            const sound = data.soundLevel || 0;
            if (sound > 40) score -= 20;
            else if (sound > 30) score -= 10;
            
            // Motion factor (less motion = better sleep)
            if (data.motionDetected) score -= 15;
            
            return Math.max(0, Math.min(100, score));
        }

        // Update sleep quality display
        function updateSleepQualityDisplay(score) {
            const scoreElement = document.getElementById('sleepScore');
            const labelElement = document.getElementById('sleepLabel');
            const descriptionElement = document.getElementById('sleepDescription');
            
            scoreElement.textContent = Math.round(score);
            
            if (score >= 80) {
                labelElement.textContent = 'Excellent Sleep';
                descriptionElement.textContent = 'Optimal conditions for restful sleep. All environmental factors are ideal.';
            } else if (score >= 60) {
                labelElement.textContent = 'Good Sleep';
                descriptionElement.textContent = 'Generally good sleep conditions with minor environmental disturbances.';
            } else if (score >= 40) {
                labelElement.textContent = 'Fair Sleep';
                descriptionElement.textContent = 'Moderate sleep conditions. Some environmental factors may affect sleep quality.';
            } else {
                labelElement.textContent = 'Poor Sleep';
                descriptionElement.textContent = 'Suboptimal sleep conditions detected. Environmental factors need attention.';
            }
        }

        // Update connection status
        function updateConnectionStatus(connected) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('connectionStatus');
            
            if (connected) {
                statusDot.classList.add('connected');
                statusText.textContent = `Connected to ESP32 (${ESP32_IP})`;
            } else {
                statusDot.classList.remove('connected');
                statusText.textContent = 'Disconnected - Retrying...';
            }
        }

        // Initialize all charts
        function initializeCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        ticks: { color: '#b19cd9' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    y: {
                        ticks: { color: '#b19cd9' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                },
                plugins: {
                    legend: {
                        labels: { color: '#b19cd9' }
                    }
                }
            };

            // Temperature Chart
            const tempCtx = document.getElementById('temperatureChart').getContext('2d');
            temperatureChart = new Chart(tempCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Temperature (째C)',
                        data: [],
                        borderColor: '#ff6b6b',
                        backgroundColor: 'rgba(255, 107, 107, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: chartOptions
            });

            // Light & Sound Chart
            const lightSoundCtx = document.getElementById('lightSoundChart').getContext('2d');
            lightSoundChart = new Chart(lightSoundCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Light Level',
                        data: [],
                        borderColor: '#ffd93d',
                        backgroundColor: 'rgba(255, 217, 61, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y'
                    }, {
                        label: 'Sound Level (dB)',
                        data: [],
                        borderColor: '#6bcf7f',
                        backgroundColor: 'rgba(107, 207, 127, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            ticks: { color: '#b19cd9' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });

            // Sleep Quality Chart
            const sleepQualityCtx = document.getElementById('sleepQualityChart').getContext('2d');
            sleepQualityChart = new Chart(sleepQualityCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Sleep Quality Score',
                        data: [],
                        borderColor: '#8a2be2',
                        backgroundColor: 'rgba(138, 43, 226, 0.2)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        y: {
                            ...chartOptions.scales.y,
                            min: 0,
                            max: 100
                        }
                    }
                }
            });

            // Motion Chart
            const motionCtx = document.getElementById('motionChart').getContext('2d');
            motionChart = new Chart(motionCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Motion Detected',
                        data: [],
                        backgroundColor: 'rgba(255, 99, 132, 0.6)',
                        borderColor: '#ff6384',
                        borderWidth: 1
                    }]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        y: {
                            ...chartOptions.scales.y,
                            min: 0,
                            max: 1
                        }
                    }
                }
            });
        }

        // Update all charts with current data
        function updateCharts() {
            // Update temperature chart
            temperatureChart.data.labels = sensorData.timestamps;
            temperatureChart.data.datasets[0].data = sensorData.temperature;
            temperatureChart.update('none');

            // Update light & sound chart
            lightSoundChart.data.labels = sensorData.timestamps;
            lightSoundChart.data.datasets[0].data = sensorData.lightLevel;
            lightSoundChart.data.datasets[1].data = sensorData.soundLevel;
            lightSoundChart.update('none');

            // Update sleep quality chart
            sleepQualityChart.data.labels = sensorData.timestamps;
            sleepQualityChart.data.datasets[0].data = sensorData.sleepQuality;
            sleepQualityChart.update('none');

            // Update motion chart
            motionChart.data.labels = sensorData.timestamps;
            motionChart.data.datasets[0].data = sensorData.motionDetected;
            motionChart.update('none');
        }

        // Control functions
        function resetData() {
            // Clear all sensor data
            Object.keys(sensorData).forEach(key => {
                sensorData[key] = [];
            });
            
            // Update charts
            updateCharts();
            
            // Reset display values
            document.getElementById('temperature').textContent = '--';
            document.getElementById('lightLevel').textContent = '--';
            document.getElementById('soundLevel').textContent = '--';
            document.getElementById('motionStatus').textContent = '--';
            document.getElementById('sleepScore').textContent = '--';
            document.getElementById('sleepLabel').textContent = 'Calculating...';
        }

        function exportData() {
            const dataToExport = {
                timestamp: new Date().toISOString(),
                sensorData: sensorData
            };
            
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `sleep_data_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        function toggleConnection() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.close();
            } else {
                connectToESP32();
            }
        }

        // Start generating mock data immediately for demo
        setTimeout(() => {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                console.log('Starting demo mode with mock data...');
                setInterval(generateMockData, 3000);
                generateMockData(); // Initial call
            }
        }, 2000);
    </script>
</body>
</html>
